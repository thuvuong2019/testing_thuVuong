---
title: "HDAT9600 Final Assignment"
author: 'McNULTY: Rory, Chen, Udoy, and Thu'
date: "23 August 2019"
output:
  html_document: default
subtitle: 'Submission deadline is 5pm Friday 23 2019 '
---

```{r setup, include=FALSE}
# leave this code here, but feel free to adjust the options or add some more
# see the knitr documentation for details
knitr::opts_chunk$set(echo = TRUE, fig.width=12, fig.height=12)
```

## Instructions

This file (hdat9600_final_assignment.Rmd) is the R Markdown document in which you need to complete your HDAT9600 final assignment. This assignment is assessed and will count for 30% of the total course marks. The assignment comprises two tasks worth 15 marks each. The first task will focus on logistic regression, and the second task will focus on survival analysis. There is no word limit, but a report of about 10 pages in length when printed (except that it will not be printed) is appropriate.

Don't hesitate to ask the course convenor for help via OpenLearning. The course instructor are happy to point you in the right direction and to make suggestions, but they won't, of course, complete your assignments for you!


## Data for this assignment

The data used for this assignment consist of records from Intensive Care Unit (ICU) hospital stays in the USA. All patients were adults who were admitted for a wide variety of reasons. ICU stays of less than 48 hours have been excluded. 

The source data for the assignment are data made freely available for the 2012 MIT PhysioNet/Computing for Cardiology Challenge. Details are provided [here](https://physionet.org/challenge/2012/). Training Set A data have been used. THe original data has been modified and assembled to suit the purpose of this assignment. Full details of the preparatory work can be found in the hdat9600-final-assignment-data-preparation file.

The dataframe consists of 120 variables, which are defined as follows:

####Patient Descriptor Variables
<li> <em>RecordID:</em>   a unique integer for each ICU stay</li>
<li> <em>Age:</em>                 years</li>
<li> <em>Gender:</em>              male/female</li>
<li> <em>Height:</em>              cm</li>
<li> <em>ICUType:</em>             Coronary Care Unit; Cardiac Surgery Recovery Unit; Medical ICU; Surgical ICU</li>
<li> <em>Length_of_stay:</em>      The number of days between the patient’s admission to the ICU and the end of hospitalisation</li>
<li> <em>Survival:</em>            The number of days between ICU admission and death for patients who died</li>


####Outcome Variables
<li> <em>in_hospital_death:</em>   0:survivor/1:died in-hospital **this is the outcome variable for Task 1: Logistic Regression**</li>
<li> <em>Status:</em>              True/False **this is the censoring variable for Task 2: Survival Analysis**</li>
<li> <em>Days:</em>                Length of survival (in days) **this is the survival time variable for Task 2: Survival Analysis**</li>


####Clinical Variables
<em>Use the hyperlinks below to find out more about the clinical meaning of each variable.</em>
The first two clinical variables are summary scores that are used to assess patient condition and risk.

<li> <em>SAPS-I score</em> [Simplified Acute Physiological Score (<a href="http://www.ncbi.nlm.nih.gov/pubmed/6499483"
target="_blank"><em>Le Gall et al., 1984</em></a>)]</li>
<li> <em>SOFA score</em> [Sequential Organ Failure Assessment (<a href="http://www.ncbi.nlm.nih.gov/pubmed/11594901"
target="_blank"><em>Ferreira et al., 2001</em></a>)]</li>

###

The following 36 clinical measures were assessed at multiple timepoints during each patient's ICU stay. For each of the 36 clinical measures, you are given 3 summary variables: a) The minimum value during the first 24 hours in ICU (_min), b) The maximum value during the first 24 hours in ICU (_max), and c) The difference between the mean and the most extreme values during the first 24 hours in ICU (_diff). For example, for the clinical measure Cholesterol, these three variables are labelled 'Cholesterol_min', 'Cholesterol_max', and 'Cholesterol_diff'.

<li><a href="http://en.wikipedia.org/wiki/Human_serum_albumin" target="_blank">
<em>Albumin</em></a> (g/dL)</li>
<li><a href="http://en.wikipedia.org/wiki/Alkaline_phosphatase" target="_blank">
<em>ALP</em></a> [Alkaline phosphatase (IU/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Alanine_transaminase" target="_blank">
<em>ALT</em></a> [Alanine transaminase (IU/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Aspartate_transaminase" target="_blank">
<em>AST</em></a> [Aspartate transaminase (IU/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Bilirubin" target="_blank">
<em>Bilirubin</em></a> (mg/dL)</li>
<li><a href="http://en.wikipedia.org/wiki/BUN" target="_blank">
<em>BUN</em></a> [Blood urea nitrogen (mg/dL)]</li>
<li><a href="http://en.wikipedia.org/wiki/Cholesterol" target="_blank">
<em>Cholesterol</em></a> (mg/dL)</li>
<li><a href="http://en.wikipedia.org/wiki/Serum_creatinine#Plasma_creatinine"
target="_blank">
<em>Creatinine</em></a> [Serum creatinine (mg/dL)]</li>
<li><a href="http://en.wikipedia.org/wiki/Diastolic_blood_pressure"
target="_blank">
<em>DiasABP</em></a> [Invasive diastolic arterial blood pressure (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/FIO2" target="_blank">
<em>FiO2</em></a> [Fractional inspired O<sub>2</sub> (0-1)]</li>
<li><a href="http://en.wikipedia.org/wiki/Glasgow_coma_score" target="_blank">
<em>GCS</em></a> [Glasgow Coma Score (3-15)]</li>
<li><a href="http://en.wikipedia.org/wiki/Serum_glucose" target="_blank">
<em>Glucose</em></a> [Serum glucose (mg/dL)]</li>
<li><a href="http://en.wikipedia.org/wiki/Bicarbonate#Diagnostics"
target="_blank">
<em>HCO3</em></a> [Serum bicarbonate (mmol/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Hematocrit" target="_blank">
<em>HCT</em></a> [Hematocrit (%)]</li>
<li><a href="http://en.wikipedia.org/wiki/Heart_rate" target="_blank">
<em>HR</em></a> [Heart rate (bpm)]</li>
<li><a href="http://en.wikipedia.org/wiki/Hypokalemia" target="_blank">
<em>K</em></a> [Serum potassium (mEq/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Lactic_acid" target="_blank">
<em>Lactate</em></a> (mmol/L)</li>
<li><a href="http://en.wikipedia.org/wiki/Magnesium#Biological_role"
target="_blank">
<em>Mg</em></a> [Serum magnesium (mmol/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Mean_arterial_pressure">
<em>MAP</em></a> [Invasive mean arterial blood pressure (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/Mechanical_ventilation"
target="_blank">
<em>MechVent</em></a> [Mechanical ventilation respiration (0:false, or 1:true)]</li>
<li><a href="http://en.wikipedia.org/wiki/Serum_sodium" target="_blank">
<em>Na</em></a> [Serum sodium (mEq/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Diastolic_blood_pressure"
target="_blank">
<em>NIDiasABP</em></a> [Non-invasive diastolic arterial blood pressure (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/Mean_arterial_pressure">
<em>NIMAP</em></a> [Non-invasive mean arterial blood pressure (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/Systolic_blood_pressure"
target="_blank">
<em>NISysABP</em></a> [Non-invasive systolic arterial blood pressure (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/Arterial_blood_gas" target="_blank">
<em>PaCO2</em></a> [partial pressure of arterial CO<sub>2</sub> (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/Arterial_blood_gas" target="_blank">
<em>PaO2</em></a> [Partial pressure of arterial O<sub>2</sub> (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/Arterial_blood_gas" target="_blank">
<em>pH</em></a> [Arterial pH (0-14)]</li>
<li><a href="http://en.wikipedia.org/wiki/Platelets" target="_blank">
<em>Platelets</em></a> (cells/nL)</li>
<li><a href="http://en.wikipedia.org/wiki/Respiratory_physiology" target="_blank">
<em>RespRate</em></a> [Respiration rate (bpm)]</li>
<li><a href="http://en.wikipedia.org/wiki/Arterial_blood_gas" target="_blank">
<em>SaO2</em></a> [O<sub>2</sub> saturation in hemoglobin (%)]</li>
<li><a href="http://en.wikipedia.org/wiki/Systolic_blood_pressure"
target="_blank">
<em>SysABP</em></a> [Invasive systolic arterial blood pressure (mmHg)]</li>
<li><a href="http://en.wikipedia.org/wiki/Normal_human_body_temperature"
target="_blank">
<em>Temp</em></a> [Temperature (&deg;C)]</li>
<li><a href="http://en.wikipedia.org/wiki/Troponin" target="_blank">
<em>TropI</em></a> [Troponin-I (&mu;g/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Troponin" target="_blank">
<em>TropT</em></a> [Troponin-T (&mu;g/L)]</li>
<li><a href="http://en.wikipedia.org/wiki/Fluid_balance" target="_blank">
<em>Urine</em></a> [Urine output (mL)]</li>
<li><a href="http://en.wikipedia.org/wiki/Reference_ranges_for_blood_tests#Hematology" target="_blank">
<em>WBC</em></a> [White blood cell count (cells/nL)]</li>
<li>
<em>Weight</em> (kg)</li>

##Load Libraries

```{r warning=FALSE, include=FALSE}
#Set up Libraries
list.of.packages <- c("ggplot2", "Rcpp", "DataExplorer", "skimr", "knitr", "DataExplorer")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)


library(tidyverse)
library(magrittr)
library(DataExplorer)
library(skimr)
library(knitr)
library(DataExplorer)

```


##Accessing the Data
The data frame can be loaded with the following code:

```{r}
icu_patients_df0 <- readRDS("icu_patients_df0.rds")
icu_patients_df1 <- readRDS("icu_patients_df1.rds")
```

###Initial look at our data


```{r results='asis'}
options(max.print=999999)
skim(icu_patients_df1) %>% skimr::kable()
```

_Most variables have been cleaned using the preliminary data-prep associated with this assignment. However, we can see that most of the continuous variables contain a few extreme maximum values and the majority of the data is not missing. A few specific variables such as DiasABP, Height, NI-pathology results, and SysABP measures are worth investigating. Additionally the outcome variable for the GLm analysis "in_hospital_death" needs to be refactored as a factor variable._


```{r}
#Change in_hospital_death to a factor variable
icu_patients_df1$in_hospital_death <- factor(icu_patients_df1$in_hospital_death, levels = c(0:1), labels = c('survivor', 'died in-hospital'))



missing_rates<- profile_missing(icu_patients_df1) %>% arrange(desc(num_missing))

missing_rates[1:25,]
```


```{r}
#Clean the dataset
clean <- function(var1, var2){
  ifelse(is.na(var1), var2, var1)
}

df1_clean <- icu_patients_df1 %>% mutate(DiasABP_diff_clean = clean(DiasABP_diff, NIDiasABP_diff)) %>%
                                  select(-DiasABP_diff, -NIDiasABP_diff) %>%
                                  mutate(DiasABP_max_clean = clean(DiasABP_max, NIDiasABP_max)) %>%
                                  select(-DiasABP_max, -NIDiasABP_max) %>%
                                  mutate(DiasABP_min_clean = clean(DiasABP_min, NIDiasABP_min)) %>%
                                  select(-DiasABP_min, -NIDiasABP_min) %>%
                                  mutate(SysABP_diff_clean = clean(SysABP_diff, NISysABP_diff)) %>%
                                  select(-SysABP_diff, -NISysABP_diff) %>%
                                  mutate(SysABP_max_clean = clean(SysABP_max, NISysABP_max)) %>%
                                  select(-SysABP_max, -NISysABP_max) %>%
                                  mutate(SysABP_min_clean = clean(SysABP_min, NISysABP_min)) %>%
                                  select(-SysABP_min, -NISysABP_min) %>%
                                  mutate(MAP_diff_clean = clean(MAP_diff, NIMAP_diff)) %>%
                                  select(-MAP_diff, -NIMAP_diff) %>%
                                  mutate(MAP_max_clean = clean(MAP_max, NIMAP_max)) %>%
                                  select(-MAP_max, -NIMAP_max) %>%
                                  mutate(MAP_min_clean = clean(MAP_min, NIMAP_min)) %>%
                                  select(-MAP_min, -NIMAP_min) 

range(df1_clean$SOFA)

df1_clean[df1_clean$SOFA == -1,]$SOFA = NA
```


2. Select an initial subset of explanatory variables that you will use to predict the risk of in-hospital death. Justify your choice.




Key take aways from the Assignment data prep:

* Patients with a total ICU stay less than 48 hours have been excluded. Of these patients we are looking at only the first 24 hours of the patient's stay in ICU
* Patients with DNR (do not resuscitate) or CMO (comfort measures only) directives were not excluded.
* Up to 42 variables were recorded at least once during the first 48 hours after admission to the ICU. Not all variables are available in all cases, however. Six of these variables are general descriptors (collected on admission), and the remainder are time series, for which multiple observations may be available.
..* Observations with multiple measures are summarised to give maximum, minimum values etc. for the first 24 hours in ICU.
..* Observations captured at admission are:
....1 RecordID (a unique integer for each ICU stay)




Note that as a team we have decieded to select similar variables for both the survival analysis and Linear modelling portions of the assessment due to the clinical relevance of these variables as both survival and death predictors. However, within each modelling task different categories of these variables have been selected (eg. Creatinine_max in linear modelling rather than Creatinine_min used in our survival analysis). This was based upon preliminary exploratory data analysis.

We chose to select the following variables with our justifications basing on background knowledge.

----Descriptor Variables:
Age, Gender (demograhpic variables) and ICU type are critical in predicting survival. The ICUType variable is for ascertaining which departments have differing death rates.

----Clinical Information Variables:
--Summary indicator
SAPS1: SAPS correctly classifies patients in groups of increasing probability of death. This scoring system was created using 14 biological/clincial indicators Specifically for ICU paitents facilitate multicentre studies and outcome comparisons. Positively correlated with in_hospital_death.
SOFA score: SOFA score is highly correlated to mortality among critical patients. For the GLM part, both indicators were used, however for the survival analysis, only SOFA was used in the univariate model.

--Liver function indicator:
Albumin_min: albumin is a marker for the goodness of liver function and it can be supplemented by injections. Therefore, if the maximum albumin amount was still low after treatment, the survival days of the patients would be shorter. No strong correlations between other predictor variables, other than other ablumin variables eg. Albumin_max - which we will not include in the analysis.

--Kidney function indicator:
Creatinine_max, BUN_min: both are markers for the badness of kidney function and it can be decreased by blood purification. Therefore, if the minimum amount was still high after treatment, the survival days of the patients would be shorter. Because they measure the same function (kidney function), univaribale analysis will be conducted on both and the one with smaller p-value will be chosen for the multivariable model.

High levels (above 250) are a clincial indicator of renal failure, which is a very serious complication somtimes requiring dialysis. Creatinine and BUN are both highly correlated with each other.

--Central nervous function indicator:
GCS_max: GCS score is a marker for the goodness of central nervous function. If the maximum score were still low after treatment, the survival days of the patients would be shorter.

--Cardiovascular function indicator:
TropI_max and TropT_max: both are markers to assess the severity of myocardial damage, and the concentration of them are proportional to the the severity. If the maximum level is high, the risk of death because of heart failure will be increasing, leading to the shorter survival time. Therefore, one of the two predictors will chosen depending on the outputs of the univariable analysis.
MAP_max_clean and MAP_min_clean: both are essential to assess the cardiovascular funtion.

--Respiratory function indicator:
PaO2_max: PaO2 is a marker for the goodness of the respiratory function. If the maximum amount of PaO2 is still low after treatment, the survival time of a patient will be shorter.
PaCO2_diff: PaCO2 is a sensitive marker for assessing gas exchange inside the lungs. If the extreme value of PaCO2 is far away from the mean value, it means higher probability of a patient lack of breathing.

--Coagulation function indicator:
Platelets_max: Platelets is a marker for the goodness of coagulation function and it can be supplemented by injection. Therefore, if the maximum platelets amount were still low after treatment, the survival days of the patients would be shorter.

--Infection indicator
WBC_min: is a indicator for the severity of infection. If the minimum amount of WBC is still high after using antibiotic, then the survival time will be shorter.


# Task 1 (15 marks)

In this task, you are required to develop a logistic regression model using the `icu_patients_df1` data set which adequately explains or predicts the `in_hospital_death` variable as the outcome using a subset of the available predictor variables. You should fit a series of models, evaluating each one, before you present your final model. Your final model should **not** include all the predictor variables, just a small subset of them, which you have selected based on statistical significance and/or background knowledge. It is perfectly acceptable to include predictor variables in your final model which are not statistically significant, as long as you justify their inclusion on medical or physiological grounds (you will not be marked down if your medical justification is not exactly correct or complete, but do you best). Aim for between five and ten predictor variables (slightly more or fewer is OK). You should assess each model you consider for goodness of fit and other relevant statistics to help you choose between them. For your final model, present a set of diagnostic statistics and/or charts and comment on them. You don't need to do an exhaustive exploratory data analysis of all the variables in the data set, but you should examine those variables that you use in your model. Finally, re-fit your final model to the unimputed data frame (`icu_patients_df0.rds`) and comment on any differences you find compared to the same model fitted to the imputed data. 


## GLM Task

1. Conduct basic exploratory data analysis on your variables of choice.


_First objectives are to assess the properties of our data, and determine which variables are correlated and assess univariate predictor variable + outcome variable relationships._

```{r} 
#subset our variables which were deemed clinically relevant
glm_analysis_df <- df1_clean[, c("in_hospital_death", "Age", "Gender", "ICUType", "SAPS1", "SOFA", "Albumin_min", "Creatinine_max", "BUN_min", "GCS_max", "TroponinI_max", "TroponinT_max", "PaO2_max", "PaCO2_diff", "Platelets_max", "WBC_min")]
```


_Check for correlations within our selected variables. Including highly correlated predictor variables may confound our model._

```{r}
plot_correlation(glm_analysis_df, maxcat = 5L, type = "d")
```

_Most ICU admissions are negatively correlated with other ICU admissions. This is intuitive as it is rare to require multiple different ICU admissions except in complex patients. Cardiac Surgery Recovery ICU and Surgical ICU are the most negatively correlated at -0.46. Gender is binary, there are no problematic correlations here._

```{r}
plot_correlation(na.omit(glm_analysis_df), maxcat = 5L, type = "c")
```

_likewise with continuous variables are mostly




_investigation of relationships between "in_hospital_death" and chosen predictor variables._

```{r}
## Call boxplot function
plot_boxplot(glm_analysis_df, by = "in_hospital_death") 

```

_From here we can see that there are a lot of outlier values which may skew the model, although a few variables such as the Age, Albumin, GCS, SOFA, and SAPS1 show some clear differences in median values when categorised by our outcome variable and do not contain many outliers. We can visualise the distributions more easily by using a facetted histogram of each predictor variable when categorised by our outcome variable._

```{r}
histogram_data <- select_if(glm_analysis_df, is.numeric) %>% cbind(glm_analysis_df["in_hospital_death"])

for(i in 2:length(histogram_data)) {

  plot <- ggplot(data=histogram_data, aes(x=histogram_data[[i]], fill=in_hospital_death)) + 
      geom_histogram() + 
      facet_grid(in_hospital_death ~ ., scales = "free") + 
      labs(x=names(histogram_data[i]), y="In Hospital Death")
  print(plot)
  
}
```


3. Fit appropriate univariate logistic regression models.

###Univariate Modelling

```{r echo=TRUE}
#repeat column names for readability
vars <- c("Age", "Gender", "ICUType", "SAPS1", "SOFA", "Albumin_min", "Creatinine_max", "BUN_min", "GCS_max", "TroponinI_max", "TroponinT_max", "PaO2_max", "PaCO2_diff", "Platelets_max", "WBC_min")

univariate_mods <- c() #initialise an empty list of vectors for the loop

for(i in vars){
  modelformula <- paste0("in_hospital_death ~ ", i) #use for loop iterator to create a formula for each variable
  univariate_mods[[i]] <- glm(as.formula(modelformula), data = glm_analysis_df, family = "binomial")
}

for(i in univariate_mods){
  print(summary(i))
}
```


_Gender, TroponinI_max, WBC_min, Platelets_max Variables were not sigificant. Other than Gender - We retain only the signficant variables within the univariate models for the multivariate modelling in subsequent analysis. Gender is retained as a standard variable to include within medical modelling._


4. Fit an appropriate series of multivariable logistic regression models, justifying your approach. Assess each model you consider for goodness of fit and other relevant statistics.

###Multivariate Modelling

```{r}
#put column names into a variable 
multivariate_vars <- paste(c( "Age", "Gender", "ICUType", "SAPS1", "SOFA", "Albumin_min", "Creatinine_max", "BUN_min", "GCS_max", "TroponinT_max", "PaO2_max", "PaCO2_diff"), collapse = " + ")

modelformula <- paste("in_hospital_death ~ ", multivariate_vars)

multivariate_mod <- glm(modelformula, data = glm_analysis_df, family = "binomial")

summary(multivariate_mod)
```

_With the exception of gender, Albumin_min, TroponinT_max, and PaCO2_diff variables were not significant and are removed to create a simplified/reduced multivariate model._

```{r}
#put column names into a variable 
reduced_multivariate_vars <- paste(c( "Age", "Gender", "ICUType", "SAPS1", "SOFA", "Creatinine_max", "BUN_min", "GCS_max", "PaO2_max"), collapse = " + ")

modelformula <- paste("in_hospital_death ~ ", reduced_multivariate_vars)

reduced_multivariate_mod <- glm(modelformula, data = glm_analysis_df, family = "binomial")

summary(reduced_multivariate_mod)
```

_All variables are now significant with the exception of gender, the next step is to compare with our more complex multivariate model with an analysis of deviance. We can already see the AIC score is lower for our reduced model._

5. Present your final model. Your final model should **not** include all the predictor variables, just a small subset of them, which you have selected based on statistical significance and/or background knowledge.

```{r}
print(anova(reduced_multivariate_mod, multivariate_mod, test="Chi")) #test to see if reduced model is significantly different from the more complex model.
```

_There appears to be no significant difference between the reduced model and complex model (p > 0.05). We can therefore retain the simplified model with a lower AIC._

6. For your final model, present a set of diagnostic statistics and/or charts and comment on them.

```{r}
plot(reduced_multivariate_mod)
```

_The QQ-plot shows heavy skewing separated into 2 clusters. The first cluster follws the normality line perfectly, however takes a sharp deviation at the first theorretical quantile. The second cluster curves up and to the right, indicating the data is right skewed. This seems to be consistent with the "in_hospital_deaths" variable._

_look at odds ratios of specific variables within the multivariate models._

```{r}
betas <- coef(reduced_multivariate_mod)

exp(betas)

exp(cbind(OR = betas, confint(reduced_multivariate_mod)))
```

_We can see the variable with the greatest leaverage is the 'ICUTypeCardiac Surgery Recovery Unit', which significantly reduces the chances of in hosptial mortality. If a patient is admitted to the Cardiac Surgery Recovery Unit they are approximately 65% less likely to die within their hospital admission (1-0.35 = 65%)._


```{r}
unimputed_multivariate_vars <- paste(c( "Age", "Gender", "ICUType", "SAPS1", "SOFA", "Creatinine_max", "BUN_min", "GCS_max", "PaO2_max"), collapse = " + ")

modelformula <- paste("in_hospital_death ~ ", unimputed_multivariate_vars)

unimputed_multivariate_mod <- glm(modelformula, data = icu_patients_df0, family = "binomial")

summary(unimputed_multivariate_mod)

plot(unimputed_multivariate_mod)
```



7. Write a paragraph summarising the most important findings of your final model. Include the most important values from the statistical output, and a simple clinical interpretation.




#####
**Create your response to this task here, as a mixture of embedded (`knitr`) R code and any resulting outputs, and explanatory or commentary text.** 



# Task 2 (15 marks)

In this task, you are required to develop a Cox proportional hazards survival model using the `icu_patients_df1` data set which adequately explains or predicts the length of survival indicated by the `Days` variable, with censoring as indicated by the `Status` variable.  You should fit a series of models, maybe three or four, evaluating each one, before you present your final model. Your final model should **not** include all the predictor variables, just a small subset of them, which you have selected based on statistical significance and/or background knowledge. Aim for between five and ten predictor variables (slightly more or fewer is OK). It is perfectly acceptable to include predictor variables in your final model which are not statistically significant, as long as you justify their inclusion on medical or physiological grounds (you will not be marked down if your medical justification is not exactly correct, but do you best). You should assess each model you consider for goodness of fit and other relevant statistics, and you should assess your final model for violations of assumptions and perform other diagnostics which you think are relevant (and modify the model if indicated, or at comment on the possible impact of what your diagnostics show). Finally, re-fit your final model to the unimputed data frame (`icu_patients_df0.rds`) and comment on any differences you find.


```{r}
#Import library
library(dplyr)
library(survival)
library(survminer)
```


1. Select an initial subset of explanatory variables that you will use to predict survival. Justify your choice.

We chose to select the following variables with our justifications basing on background knowledge.

----Descriptor Variables:
Age, Gender (demograhpic variables) and ICU type are critical in predicting survival.

----Clinical Information Variables:
--Summary indicator
SAPS1: SAPS correctly classifies patients in groups of increasing probability of death. 
SOFA score: SOFA score is highly correlated to mortality among critical patients. Because the two measures are similar, SOFA score was chosen for our univariate model.

--Liver function indicator:
Albumin_max: albumin is a marker for the goodness of liver function and it can be supplemented by injection. Therefore, if the maximum albumin amount was still low after treatment, the survival days of the patients would be shorter.

--Kidney function indicator:
Creatinine_min, BUN_min: both are markers for the badness of kidney function and it can be decreased by blood purification. Therefore, if the minimum amount was still high after treatment, the survival days of the patients would be shorter. Because they measure the same function (kidney function), univaribale analysis will be conducted on both and the one with smaller p-value will be chosen for the multivariable model.

--Central nervous function indicator:
GCS_max: GSC score is a marker for the goodness of central nervous function. If the maximum score were still low after treatment, the survival days of the patients would be shorter.

--Cardiovascular function indicator:
TropI_max and TropT_max: both are markers to assess the severity of myocardial damage, and the concentration of them are proportional to the the severity. If the maximum level is high, the risk of death because of heart failure will be increasing, leading to the shorter survival time. Therefore, one of the two predictors will chosen depending on the outputs of the univariable analysis.
MAP_max_clean and MAP_min_clean: both are essential to assess the cardiovascular funtion.

--Respiratory function indicator:
PaO2_max: PaO2 is a marker for the goodness of the respiratory function. If the maximum amount of PaO2 is still low after treatment, the survival time of a patient will be shorter.
PaCO2_diff: PaCO2 is a sensitive marker for assessing gas exchange inside the lungs. If the extreme value of PaCO2 is far away from the mean value, it means higher probability of a patient lack of breathing.

--Coagulation function indicator:
Platelets_max: Platelets ia a marker for the goodness of coagulation function and it can be supplemented by injection. Therefore, if the maximum platelets amount were still low after treatment, the survival days of the patients would be shorter.

--Infection indicator
WBC_min: is a indicator for the severity of infection. If the minimum amount of WBC is still high after using antibiotic, then the survival time will be shorter.



2. Conduct basic exploratory data analysis on your variables of choice.

```{r}
#Identify the number of rows (patients)
n = nrow(df1_clean)
n

summary(df1_clean$Status)

#Identify the number of Days
summary(df1_clean$Days)

#Report the number of deaths by categories for ICUType:
print(survfit( Surv(Days, Status)~ ICUType, data=df1_clean))

#Report the number of deaths by categories for Gender:
print(survfit( Surv(Days, Status)~ Gender, data=df1_clean))
```


```{r fig.height=5, fig.width=8}
#plotting the Kaplan_Meier survival curve to have a sense of the survival rate
om.fit <- survfit(Surv(Days, Status) ~ 1, data = df1_clean) 
plot(om.fit, xlim = c(1, 2500), main = 'Kaplan-Meier survival curve', xlab = 'Days')
```


```{r fig.height=5, fig.width=8}
om.fit_2 <- survfit(Surv(Days, Status) ~ Gender, data = df1_clean) 
plot(om.fit_2, col=c("blue", "red"), xlim = c(1, 2500), main = 'Kaplan-Meier survival curve by Gender', xlab = 'Days')

om.fit_3 <- survfit(Surv(Days, Status) ~ ICUType, data = df1_clean) 
plot(om.fit_3, col=c("blue", "red", "purple", "orange"), xlim = c(1, 2500), main = 'Kaplan-Meier survival curve by ICU Type', xlab = 'Days')
```
_Results from the EDA show that there were 2061 patients under observation in this study, of whom 773 died (37.5%), as illustrated by the overall survival curve, which decays at around 0.6. Of all patients under observation, 1148 (55.7%) were male. The patients were under observation for a minimum of 0 days and maximum of 2408 days, with the majority under observation towards the end (median=2408 days). There were four ICU types with the majority of patients being admitted to Medical ICU (788 = 38.2%). The sub-group survival curves suggest that there was no difference between male and female. However, there seems to be a stark differences in survival rate between ICU types._

3. Fit appropriate univariate Cox proportional hazards models.

```{r}
#univariable analysis on descriptor Variables
coxph(Surv(Days, Status) ~ Age, data = df1_clean)
coxph(Surv(Days, Status) ~ Gender, data = df1_clean)
coxph(Surv(Days, Status) ~ ICUType, data = df1_clean)
```
_Age and ICU_type are statistically significant. Gender is marginally significant with p=0.057. However, because gender is an important demographic variable, it will be included in the multivariable model._

```{r}
#univariable analysis on Summary indicator:
coxph(Surv(Days, Status) ~ SOFA, data = df1_clean)
```
_SOFA score is statistically significant._

```{r}
#univariable analysis on liver function indicator
coxph(Surv(Days, Status) ~ Albumin_max, data = df1_clean)
```
_Albumin_max measure is statistically significant._

```{r}
#univariable analysis on kidney function indicators
coxph(Surv(Days, Status) ~ Creatinine_min, data = df1_clean)
coxph(Surv(Days, Status) ~ BUN_min, data = df1_clean)
```

_Both Creatinine_min and BUN_min are statistically significant. However, BUN_min has a smaller p-value. Therefore, only BUN_min will be used for the multivariable model._

```{r}
#univariable analysis on central nervous function indicator
coxph(Surv(Days, Status) ~ GCS_max, data = df1_clean)
```

_GCS_max score is statistically significant._

```{r}
#univariable analysis on ardiovascular function indicator
coxph(Surv(Days, Status) ~ TroponinI_max, data = df1_clean)
coxph(Surv(Days, Status) ~ TroponinT_max, data = df1_clean)
coxph(Surv(Days, Status) ~ MAP_max_clean, data = df1_clean)
coxph(Surv(Days, Status) ~ MAP_min_clean, data = df1_clean)
```

_Only TroponinT_max and MAP_min_clean are statistically significant._

```{r}
#univariable analysis on respiratory function indicator
coxph(Surv(Days, Status) ~ PaO2_max, data = df1_clean)
coxph(Surv(Days, Status) ~ PaCO2_diff, data = df1_clean)
```

_Both PaO2_max and PaCO2_diff are statistically significant._

```{r}
#univariable analysis on coagulation function indicator
coxph(Surv(Days, Status) ~ Platelets_max, data = df1_clean)
```
_Platelets_max is not statistical significant._

```{r}
coxph(Surv(Days, Status) ~ WBC_min, data = df1_clean)

```

_WBC_min is not statistical significance._


4. Fit an appropriate series of multivariable Cox proportional hazards models, justifying your approach. Assess each model you consider for goodness of fit and other relevant statistics.

```{r}
#multivariable model with all variables determined as important from clinical background knowledge and outputs of the univariable model:
full_model <- coxph(Surv(Days, Status) ~ Age + Gender + ICUType + SOFA + BUN_min + 
               GCS_max + TroponinT_max + MAP_min_clean + PaO2_max + PaCO2_diff 
                + Platelets_max, data = df1_clean)
summary(full_model)
```
_The following variables are not statistically significant in the multivariable model: gender, MAP_min_clean and Platelets_max. Given gender is one important demographic variable, it is kept in the final model._  

5. Present your final model. Your final model should **not** include all the predictor variables, just a small subset of them, which you have selected based on statistical significance and/or background knowledge.

```{r}
#reduceed model with MAP_min_clean and Platelets_max removed:
reduced_model <- coxph(Surv(Days, Status) ~ Age + Gender + ICUType + SOFA + BUN_min + 
               GCS_max + TroponinT_max + PaO2_max + PaCO2_diff, data = df1_clean)
summary(reduced_model)
```


```{r}
#conduct likelihood ratio test to compared goodness of fit of the two models (full_model and reduced model)
print(anova(full_model, reduced_model))
AIC(full_model, reduced_model)
```
_The LRT shows that the maximum log likelihood (MLL) of the full_model is larger (i.e. better) than that of the reduced model (-5481.4 vs -5482.3). However, the difference between the MLL of the two models was not significant (p=0.4077). Hence, the simpler model (reduced_model) should be chosen. This is confirmed by the AIC. The reduced model has a smaller AIC (10986.66) (better) compared to the AIC of the full_model (10988.86)_


6. For your final model, present a set of diagnostic statistics and/or charts and comment on them. 

```{r fig.height=8, fig.width=16}
#Check whether the proportional hazards assumptions hold for the variables included in the reduced_model.
prop.reduced_model <- cox.zph(reduced_model)
prop.reduced_model
ggcoxzph(prop.reduced_model)
```
_The global test for proportional hazards is significant and this is largely due to the three predictor variables (ICU_type, SOFA and GCS_max)._


```{r fig.height=5, fig.width=8}
# plot the survival functions by treatment 'ICUtype' again here to identify the trajectory for strategy to stratify "Days"
om.fitbyICUType <- survfit(Surv(Days, Status) ~ ICUType, data = df1_clean) 
plot (om.fitbyICUType, col=c("blue", "red", "purple", "orange"), xlim = c(1, 2500), main = 'Kaplan-Meier estimate of survival function', xlab = 'Treatment type')
```


```{r fig.height=4, fig.width=8}
#add 0.5 to all values of Variable Days to fix error of event occuring on day 0 "'zero' parameter must be less than any observed times"
df1_clean$Days2 <- df1_clean$Days + 0.5

#the curves seem to change at Days = 500 and Days = 1000
om.split <- survSplit( Surv(Days2, Status) ~ ., data = df1_clean, cut=c(500, 1000), episode= "tgroup", id="id2")
```


```{r fig.height=8, fig.width=16}
#fitting the reduced_model again with the split of Days (tgroup) into three intervals, by creating x and time interactions for the three variables that violate the proportional hazards assumptions (ICUType and GCS_max).  
reduced_model_split <- coxph(Surv(Days, Status) ~ Age + Gender + ICUType:strata(tgroup) +  SOFA:strata(tgroup) + BUN_min + GCS_max:strata(tgroup) + TroponinT_max + PaO2_max + PaCO2_diff, data = om.split)
summary(reduced_model_split)

prop.reduced_model_split <- cox.zph(reduced_model_split)
prop.reduced_model_split
ggcoxzph(prop.reduced_model_split)
```

_The outputs show that the global test for proportional hazards is no longer significant (p=0.4628) and 'ICUType', 'SOFA' and "GCS_max' no longer violate the proportional hazards assumption._

```{r}
#Refiting the reducedmodel with the unimputed data and compare the outputs of the two models (one with imputed data and one with unimputed data)
reduced_model <- coxph(Surv(Days, Status) ~ Age + Gender + ICUType + SOFA + BUN_min + 
               GCS_max + TroponinT_max + PaO2_max + PaCO2_diff, data = df1_clean)
summary(reduced_model)

reduced_model_unimputed <- coxph(Surv(Days, Status) ~ Age + Gender + ICUType + SOFA + BUN_min + 
               GCS_max + TroponinT_max + PaO2_max + PaCO2_diff, data = icu_patients_df0)
summary(reduced_model_unimputed)

```

_The outputs of the reduced_model using the two different datasets are different:_
_The imputed dataset shows that n= 2061, number of events= 773, while unimputed dataset shows only n= 300, number of events= 145 (1761 observations deleted due to missingness)_
_As such, the coefficients are also different: all the variables of the reduced model are significant (except Gender) using the imputed data while only two variables (BUN_min, and GCS_max) are significant using the unimputed data._



7. Write a very brief paragraph summarising the most important findings of your final model. Include the most important values from the statistical output, and a simple clinical interpretation. 

_The outputs from the multivariable Cox model (reduced_model) with interaction terms indicate that “Age” has a statistically significant effect on risk of death in that for each year older, the risk of death was increased by 3% (as indicated by the exp(coef) value of 1.03 (p<0.0001). Gender did not have an effect on risk of death but it is important to keep it in the model because it is one of the key demographic variable. Of the three time intervals of observation: 1) 0-500 days; 2) 501-1000 days; and 3) >1000 days, significant difference was only indicated beween ICUType, SOFA, and GCS_max for the first time intervals. No significant difference was obverved during the second and third time intervals._
_Within the first time interval (Days from 0 to 500):_
_•The risk of death among patients admitted to “Cardiac Surgery Recovery Unit” was 57.3% lower (exp(coef) value of 0.427) compared to patients admited to “Surgical ICU” and this difference was statistically significant with p<0.0001._ 
_•The risk of death among patients admitted to “Medical ICU” was 26.5% higher (exp(coef) value of 1.265) compared to patients admited to “Surgical ICU” and this difference was statistically significant with p<0.05._ 
_•There was no difference beween patients admitted to “Coronary Care Unit” and patients admited to “Surgical ICU” in risk of death._
_•For the central nervous function indicator (GCS_max), a marker for the goodness of central nervous function, patients with one GCS score higher has a 8.5% reduced risk of death (exp(coef) value of 0.9159) with p<0.0001. However, this statistical significant effect was only observed during the first time interval, not in the second and third time interval._


## Save, knit and submit

**Reminder**: don't forget to save this file, to knit it to check that everything works, and then submit via the drop box in Openlearning.

## Submit your assignment

When you have finished, and are satisfied with your assignment solutions, and this file knits without errors and the output looks the way you want, then you should submit via the drop box in Openlearning.

### Problems?

If you encounter problems with any part of the process described above, please contact the course instructor via OpenLearning as soon as possible so that the issues can be resolved in good time, and well before the assignment is due.


### Additional Information

Each task attracts the indicated number of marks (out of a total of 30 marks for the assignment). The instructions are deliberately open-ended and less prescriptive than the individual assignments to allow you some latitude in what you do and how you go about the task. However, to complete the tasks and gain full marks, you only need to replicate or repeat the steps covered in the course - if you do most or all of the things described in the revalant chapters of the HDAT9600 course, full marks wil be awarded. 

Note also that with respect to the model fitting, there are no **right** or **wrong** answers when it comes to variable selection and other aspects of model specification. Deep understanding of the underlying medical concepts which govern patient treatment and outcomes in ICUs is not required or assumed, although you should try to gain some understanding of each variable using the links provided. You will not be marked down if your medical justifications are not exactly correct or complete, but do you best, and don't hesitate to seek help from the course instructor.
